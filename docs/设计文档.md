# 网格交易神器设计文档

## 1 引言

### 1.1 项目背景

网格交易是一种经典的量化交易策略，其核心思想是在价格区间内通过分批买入和卖出，捕捉市场波动带来的收益。

该策略具有逻辑清晰、规则固定、易于程序化实现等特点，适合用于量化交易教学与策略验证。

本项目旨在设计并实现一款 **基于命令行的网格交易回测软件** ，用户可通过设置策略参数并导入历史行情数据，对网格交易策略在历史数据上的表现进行验证和分析，从而评估策略的有效性与风险特征。

### 1.2 设计目标

本系统的设计目标包括：

* 支持用户自定义网格交易策略参数
* 根据参数自动生成完整的网格交易模型
* 基于历史行情数据进行策略回测
* 记录完整的交易过程与资金变化
* 输出标准量化投资绩效指标，为策略评估提供依据

---

## 2 系统总体设计

### 2.1 系统运行方式

系统采用**命令行交互方式**运行，用户通过命令行输入策略参数与历史数据路径，系统自动完成模型构建与回测计算，并在终端输出回测结果。

该设计方式具有如下优点：

* 结构简单，易于测试与调试
* 便于自动化回测与批量实验
* 更贴近真实量化研究流程

### 2.2 系统总体结构

系统从功能上可划分为以下几个主要模块：

1. **参数输入模块**
   负责接收并校验用户输入的网格交易参数。
2. **策略模型生成模块**
   根据用户参数构建完整的网格交易模型，包括各行价格、买卖条件及仓位状态。
3. **历史数据读取模块**
   读取用户提供的指数历史行情数据，并进行必要的数据预处理。
4. **回测引擎模块**
   按时间顺序模拟市场价格变化，驱动网格交易策略执行买卖操作。
5. **交易记录与资金管理模块**
   记录每一笔交易的详细信息，并动态统计资金使用情况。
6. **绩效分析模块**
   基于回测结果计算各类投资业绩指标。

模块之间通过明确的数据接口进行交互，整体结构清晰，职责分明。

---

## 3 网格交易模型设计

### 3.1 基本术语定义

为便于描述算法逻辑，系统定义如下概念：

* **入网** ：股价跌至或低于首行买入触发价，即股价 ≤ 首行买入价。
* **出网** ：股价高于首行买入触发价。
* **股价位于第 i 行** ：满足第 (i+1) 行买入价 < 当前股价 ≤ 第 i 行买入价。
* **位置 i 满仓** ：在第 i 行价格条件下完成买入且尚未卖出。
* **位置 i 空仓** ：第 i 行已完成卖出操作，等待再次买入。

---

### 3.2 模型初始化逻辑

算法启动时，系统处于 **空仓状态** ，不持有任何资产。

初始化过程分为两种情况：

1. **当前股价处于出网状态**
   系统不执行任何操作，持续等待价格下跌至入网状态。当价格首次入网后，按照首行参数执行买入操作。
2. **当前股价已处于入网状态**
   若算法启动时股价位于第 i 行，则系统按照当前价格一次性完成第 1 行至第 i 行的全部买入操作，以确保策略状态与市场位置一致。

初始化完成后，系统至少持有首行对应数量的股票。

---

### 3.3 网格交易执行逻辑

在回测过程中，系统根据价格变化不断执行以下逻辑判断。整体策略由一系列 **if–else 条件结构**组成，逻辑确定且可复现。

* **价格下跌处理**
  当股价下跌至第 i+1 行：

  * 若该位置为空仓，则按该行参数执行买入操作；
  * 若该位置已满仓，则不执行任何操作。
* **价格上涨处理**
  当股价上涨至第 i 行的卖出价：

  * 若该位置为满仓，则按该行参数执行卖出操作；
  * 若该位置为空仓，则不执行任何操作。
* **最后一日处理**

  为了真实计算相关指标，回测的最后一日会将所有仓卖出，即清仓处理。

考虑市场买卖限制，在卖出时会额外检查建仓时间与卖出时间是否为同一天，如果为同一天，为了模拟真实市场环境，将无法进行卖出操作。

通过上述规则，系统在价格波动中不断完成低买高卖，实现网格交易策略。

---

## 4 实现细节设计

### 4.1 滑点处理

为模拟真实交易环境，系统在买入和卖出时考虑滑点：

- 买入价 = 买入触发价 - 0.005
- 卖出触发价 = 卖出价 - 0.005

### 4.2 资金管理

- 初始资金：默认等于各网格行买入金额之和，可自定义
- 资金检查：买入时检查现金余额是否足够
- 占用资金：动态跟踪当前占用资金和最大占用资金

### 4.3 同日交易限制

- 每个网格行同一天内只能执行一次交易（买入或卖出）
- 通过记录最后交易日期实现限制

### 4.4 最后一天清仓

回测最后一天强制卖出所有持仓，确保策略完全平仓。

### 4.5 异常处理

- 参数校验：输入类型和范围检查
- 文件校验：路径存在性和格式检查
- 数据库异常：连接失败和事务回滚
- 计算异常：数值溢出和无效结果处理

---

## 5 模型参数设计

### 4.1 策略参数说明

整个网格交易模型由以下五个参数决定：

* **目标波动率 a** ：控制网格密度，取值范围为 (5%, 30%)
* **单行收益率 b** ：控制每一行的目标盈利，取值范围为 (5%, 30%)
* **首行买入触发价**
* **模型行数**
* **每行买入金额**

所有参数均由用户在命令行中输入设置。

---

### 4.2 模型构造方法

系统根据参数通过如下公式生成完整网格结构：

* 第 i 行档位值

$$
`档位_i = \frac{档位_{i-1}}{1 + a/2}`
$$

* 第 i 行买入价
  $$
  `买入价_i = 首行买入价 \times 档位_i`
  $$
* 第 i 行卖出价

$$
`卖出价_i = 买入价_i \times (1 + b)`
$$

每行买入股数

$$
股数 = \left\lfloor \frac{买入金额}{买入价_i} \right\rfloor
$$

通过上述公式，系统可自动生成完整、结构一致的网格交易模型。

---

## 5 回测与结果分析设计

### 5.1 回测数据来源

系统支持用户导入从中证指数公司官网下载的历史行情数据，可自定义初始资金（默认覆盖所有仓位）。

### 5.2 回测结果输出

回测过程中系统将：

* 记录每一笔交易的日期、价格和数量
* 统计策略执行过程中最大资金占用情况
* 计算并输出以下绩效指标：
  * XIRR 收益率
  * 最终总资产
  * 简单收益率
  * 最大占用资金
  * 最大回撤（相对初始资金）
  * 最大回撤（相对峰值）
  * 夏普比率
  * 年化波动率
* 最终将结果和过程文件保存为excell文件以供随时查看。

---

## 6 数据格式要求

### 6.1 行情数据格式

系统支持从Excel文件导入历史行情数据，文件必须包含以下列：

- Date (日期，格式：YYYYMMDD)
- Index Code (指数代码)
- Open (开盘价)
- High (最高价)
- Low (最低价)
- Close (收盘价)
- Change(%) (涨跌幅)

---



## 7 系统要求

### 7.1 软件环境

- Python 3.8+
- 操作系统：Windows/Linux/macOS
- 内存：4GB以上
- 硬盘：100MB可用空间

### 7.2 关键依赖包

- sqlalchemy：数据库ORM
- pandas：数据处理
- numpy：数值计算
- tabulate：表格显示
- openpyxl：Excel操作
