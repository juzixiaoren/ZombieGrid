# 网格交易神器数据库设计

## 1 数据库概述

### 1.1 数据库类型

使用SQLite作为嵌入式数据库，无需单独安装服务器。

### 1.2 ORM框架

采用SQLAlchemy ORM进行对象关系映射，提供类型安全和易用的API。

### 1.3 连接配置

```python
SQLALCHEMY_DATABASE_URI = 'sqlite:///data/database_folder/zombiegrid.db'
```

## 2 表结构设计

### 2.1 GridConfig表（策略配置表）

#### 表描述

存储网格交易策略的基本配置信息。

#### 字段定义

| 字段名              | 数据类型    | 约束                       | 说明                         |
| ------------------- | ----------- | -------------------------- | ---------------------------- |
| id                  | Integer     | PRIMARY KEY, AUTOINCREMENT | 策略ID，主键                 |
| name                | String(100) | NULL                       | 策略名称，可选               |
| a                   | Float       | NOT NULL                   | 波动捕捉大小参数 (0.05-0.30) |
| b                   | Float       | NOT NULL                   | 每行收益率参数 (0.05-0.30)   |
| first_trigger_price | Float       | NOT NULL                   | 首个触发价                   |
| total_rows          | Integer     | NOT NULL                   | 模型行数                     |
| buy_amount          | Float       | NOT NULL                   | 每次买入金额                 |
| last_modified       | DateTime    | DEFAULT CURRENT_TIMESTAMP  | 最后修改时间                 |

#### 索引

- 主键索引：id
- 普通索引：last_modified（用于排序）

### 2.2 GridRow表（网格行数据表）

#### 表描述

存储每个策略对应的网格行详细信息。

#### 字段定义

| 字段名             | 数据类型 | 约束                       | 说明                 |
| ------------------ | -------- | -------------------------- | -------------------- |
| id                 | Integer  | PRIMARY KEY, AUTOINCREMENT | 行ID，主键           |
| config_id          | Integer  | NOT NULL, FOREIGN KEY      | 关联策略ID           |
| fall_percent       | Float    | NOT NULL                   | 跌幅百分比           |
| level_ratio        | Float    | NOT NULL                   | 档位比例             |
| buy_trigger_price  | Float    | NOT NULL                   | 买入触发价           |
| buy_price          | Float    | NOT NULL                   | 实际买入价（含滑点） |
| buy_amount         | Float    | NOT NULL                   | 买入金额             |
| shares             | Float    | NOT NULL                   | 买入股数             |
| sell_trigger_price | Float    | NOT NULL                   | 卖出触发价           |
| sell_price         | Float    | NOT NULL                   | 实际卖出价           |
| yield_rate         | Float    | NOT NULL                   | 收益率               |
| profit_amount      | Float    | NOT NULL                   | 预期盈利金额         |

#### 索引

- 主键索引：id
- 外键索引：config_id
- 复合索引：(config_id, id) 用于按策略查询行数据

### 2.3 ImportedFiles表（导入文件记录表）

#### 表描述

记录每次数据导入的元信息。

#### 字段定义

| 字段名       | 数据类型    | 约束                       | 说明         |
| ------------ | ----------- | -------------------------- | ------------ |
| id           | Integer     | PRIMARY KEY, AUTOINCREMENT | 导入ID，主键 |
| file_name    | String(255) | NULL                       | 原始文件名   |
| index_code   | String(50)  | NOT NULL                   | 指数代码     |
| record_count | Integer     | NULL                       | 数据记录数   |
| date_range   | String(100) | NULL                       | 日期范围描述 |

#### 索引

- 主键索引：id
- 普通索引：index_code

### 2.4 IndexData表（指数行情数据表）

#### 表描述

存储具体的指数行情数据。

#### 字段定义

| 字段名         | 数据类型   | 约束                       | 说明         |
| -------------- | ---------- | -------------------------- | ------------ |
| id             | Integer    | PRIMARY KEY, AUTOINCREMENT | 数据ID，主键 |
| import_id      | Integer    | NOT NULL, FOREIGN KEY      | 关联导入ID   |
| date           | Date       | NOT NULL                   | 交易日期     |
| index_code     | String(50) | NOT NULL                   | 指数代码     |
| open_price     | Float      | NOT NULL                   | 开盘价       |
| high_price     | Float      | NOT NULL                   | 最高价       |
| low_price      | Float      | NOT NULL                   | 最低价       |
| close_price    | Float      | NOT NULL                   | 收盘价       |
| change_percent | Float      | NOT NULL                   | 涨跌幅(%)    |

#### 索引

- 主键索引：id
- 外键索引：import_id
- 复合索引：(import_id, date) 用于按导入批次和日期查询

## 3 关系设计

### 3.1 ER图

```
GridConfig (1) ──── (N) GridRow
    │
    └── (1) ImportedFiles (1) ──── (N) IndexData
```

### 3.2 外键约束

- GridRow.config_id → GridConfig.id (CASCADE DELETE)
- IndexData.import_id → ImportedFiles.id (CASCADE DELETE)

### 3.3 数据完整性

- 使用外键约束保证引用完整性
- 使用NOT NULL约束保证必填字段
- 使用CHECK约束限制参数范围（通过应用层校验）

## 4 数据访问层设计

### 4.1 DBSessionManager类

```python
class DBSessionManager:
    def __init__(self, db_url):
        self.engine = create_engine(db_url)
        self.SessionLocal = sessionmaker(bind=self.engine)
  
    def __enter__(self):
        self.session = self.SessionLocal()
        return self.session
  
    def __exit__(self, exc_type, exc_val, exc_tb):
        if exc_type:
            self.session.rollback()
        else:
            self.session.commit()
        self.session.close()
```

### 4.2 主要操作

- **策略管理**：

  - `save_grid_config()`: 保存策略配置
  - `get_grid_configs()`: 查询策略列表
  - `delete_strategy_by_id()`: 删除策略及其行数据
- **数据管理**：

  - `import_market_data()`: 导入行情数据
  - `get_imported_files()`: 查询导入记录
  - `delete_import_batch()`: 删除导入批次及其数据
